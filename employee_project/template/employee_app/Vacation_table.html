{% extends "employee_app/base.html" %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
{% block title %} Vacation Table {% endblock %}
{% block header %}Vacation Table:{% endblock %}
{% block container_block %}
<style>
  .content {
background:white;
padding-left:50px;
margin-right:-330px;
margin-left:-360px;
padding-bottom:15px;
margin-top:-20px;

}  


.margin{margin-right:250px;}

  td.details-control {
    background: url('https://datatables.net/examples/resources/details_open.png') no-repeat center center;
    cursor: pointer;
}
tr.shown td.details-control {
    background: url('https://datatables.net/examples/resources/details_close.png') no-repeat center center;
}  


</style>
{% csrf_token %}

<button class="btn btn-dark btn-lg " type="button" id="table_btn"><i class="fa fa-list" aria-hidden="true"></i></button>
<button class="btn btn-dark btn-lg " type="button" id="calendar_btn"><i class="fa fa-calendar" aria-hidden="true"></i></button>
<br/><br/>

<div class="col-sm-12" id="calendar_view">
<div id="calendar">
</div>
</div>


<div class="row">
 <div class="col-sm-12" id="table">
<table id="vacation_table"  class="table table-hover table-condensed  form-control table-striped  responsive nowrap row-border cell-border"   style="min-height:75%;width:97%" >
<thead>
<tr>
<th></th>
<th>Description</th>
<th>DateFrom</th>
<th>DateTo</th>
<th>Duration</th>  
<th >Status</th>
<th>Actions</th>
</tr>
</thead>

<tbody>
</tbody>
<tfoot>
<tr>
<th></th>
<th style="width:140px;" data-searchable="true">Description</th>
<th style="width:140px;" data-searchable="true">Date_From</th>
<th style="width:140px;" data-searchable="true">Date_To</th>
<th style="width:140px;" data-searchable="true" >Duration</th>
<th style="width:140px;" data-searchable="false">Status</th>
<th style="width:14000px;" data-searchable="false">Action</th>

</tr>
</tfoot>
</table>
</div> 
</div>
<center><a  href="{% url  'Vacation_Fields' %}" class="btn btn-primary btn-lg" style="width:20%">Add Vacation</a></center>
 
 <div class="modal" role="dialog" id="vacation_status_modal">
    <div class="modal-dialog">
    
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" id="Close_status" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Update Vacation Status</h4>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to update?</p>
          <input name="vacation_id" type="hidden" />
        </div>
        <div class="modal-footer">
          <button type="button" id="save_status" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-default" id="close_status" data-dismiss="modal">Close</button>
        </div>
      </div>
      
    </div>
  </div>
  
  <div class="modal" role="dialog" id="vacation_delete_modal">
    <div class="modal-dialog">
    
      <div class="modal-content">
        <div class="modal-header">
         <button type="button" id="Close_delete" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Delete Vacation </h4>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete vacation?</p>
          <input name="vacation_id" type="hidden" />
        </div>
        <div class="modal-footer">
          <button type="button" id="delete_vacation" class="btn btn-primary">Delete</button>
          <button type="button" class="btn btn-default" id="close_delete" data-dismiss="modal">Close</button>
        </div>
      </div>
      
    </div>
  </div>
{% endblock %}


  
<script src="http://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>

<script src="https://preview.keenthemes.com/metronic/theme/html/demo1/dist/assets/plugins/custom/fullcalendar/fullcalendar.bundle.js?v=7.2.5"></script>
<link rel="stylesheet" type="text/css" href="https://preview.keenthemes.com/metronic/theme/html/demo1/dist/assets/plugins/custom/fullcalendar/fullcalendar.bundle.css?v=7.2.5">
{% block scripts %}
<script>

function format ( rowData ) {
    var div = $('<div/>')
        .addClass( 'loading' )
        .text( 'Loading...' );
 
    	div.load("{% url 'vacation_details' %}?id="+rowData.id)
 
    return div;
}


$(function(){
		
		$("#calendar_view").hide();
		$("#table_btn").css("background","red");
		
		$("#table_btn").click(function(){
				
				$("#table").show();
				$("#calendar_view").hide();
				$("#table_btn").css("background","red");
				$("#calendar_btn").css("background","blue");
				

			
		});
		
		$("#calendar_btn").click(function(){
			
			$("#calendar_view").show();
			$("#table").hide();
			$("#calendar_btn").css("background","red");
			$("#table_btn").css("background","blue");
			

	     });
		
	var vacation_table = $(" #vacation_table ").DataTable( {
		ajax: {
			url: '{% url "vacation_grid" %}',
			type: "POST",
			data: function(d){
				d.csrfmiddlewaretoken = $("input[name=csrfmiddlewaretoken]").val()
				d.user_id = "{{request.user.id}}"
		     	
			}
			
		},
		lengthMenu: [ 5, 10, 25, 50],
		pageLength: 5,
		processing: true,
		serverSide: true,
	    columns: [
	     		 {
	                "className":      'details-control',
	                "orderable":      false,
	                "data":           null,
	                "defaultContent": ''
	            },  
	    	
		   {'data': 'Description', 'name': 'Description', 'sortable': true},
		   {'data': 'Datetime_From', 'name': 'Datetime_From', 'sortable': true},
		   {'data': 'Datetime_To', 'name': 'Datetime_To', 'sortable': true},
 		   {'data': 'Duration', 'name': 'Duration', 'sortable': true},  
		   {'data': 'status', 'name': 'status'},
		   {'data': 'action'} ,
	],
 	 "order": [[1, 'asc']], 
	    columnDefs: [
		{
			targets: -1, 
			title: 'Actions',
			render: function(data, type, full, meta){
				var edit_Description = "{% url 'Vacation_Fields' %}?id=" + full.id;
				return "<button class='btn btn-info btn-sm' type='button'><a href='"+edit_Description+" '><i class='fa fa-edit'></i></a></button> <button class='btn btn-success btn-sm btn-update' type='button' data-id="+full.id+"><i class='fa fa-refresh'></i></button><button class='btn btn-danger btn-sm btn-delete' type='button' data-id="+full.id+"><i class='fa fa-trash'></i></button>"
	
			}
			
		}
	],
	createdRow: function(row, data, dataIndex){
		console.log(data)
		if(data['status'] == "Active"){
			$(row).css({'background-color': "#88BF9A"})
		}else{
			$(row).css({'background-color': "red"})
		}
	}
});


$(" #vacation_table tfoot th[data-searchable=true]").each(function(){
	var title= $(this).text();
	$(this).html('<input type="text" placeholder="Search ' + title + '" />');
});
	   vacation_table.columns().every(function(){
		var column=this;
		$("input" , this.footer()).on('input' , function(){
			if (column.search() !== this.value){
				column.search(this.value).draw();
			}
		})
		
	});
	   $("#vacation_table tbody").on('click', '.btn-update', function(){
			$("#vacation_status_modal").show();
			$("input[name=vacation_id]").val($(this).attr('data-id'));
		});
		
		$("#save_status").click(function(){
			$.ajax({
				type:"POST",
				url: "{% url 'update_status' %}",
				data:{
					vacation_id: $("input[name=vacation_id]").val(),
					csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
				},
				dataType: 'json',
				success: function(response){
					console.log(response)
					
					if(response.status == 'OK'){
						toastr.success('Vacation status updated');
						vacation_table.ajax.reload(); 
						$("#vacation_status_modal").hide();
					}else {
						if(response.message == "VACATION_NOT_FOUND"){
							toastr.error('Vacation not found')											
						}else if(response.message == "MISSING_REQUIRED_PARAMETERS"){
							toastr.success("You have missing parameters");
						}
					}	
			    }, 
			    error: function(){
			    	alert("Error in save")
				}
			});
		});
		
		 $("#close_status").click(function(){
				
				$("#vacation_status_modal").hide();
			 });
		 $("#Close_status").click(function(){
				
				$("#vacation_status_modal").hide();
			 });
		
		
		 $("#vacation_table tbody").on('click', '.btn-delete', function(){
				$("#vacation_delete_modal").show();
				$("input[name=vacation_id]").val($(this).attr('data-id'));
			});
			
			$("#delete_vacation").click(function(){
				$.ajax({
					type:"POST",
					url: "{% url 'delete_vacation' %}",
					data:{
						vacation_id: $("input[name=vacation_id]").val(),
						csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
					},
					dataType: 'json',
					success: function(response){
						console.log(response)
						
						if(response.status == 'OK'){
							toastr.success('Vacation deleted Successufly');
							vacation_table.ajax.reload(); 
							$("#vacation_delete_modal").hide();
						}else{
							if(response.message == "VACATION_NOT_FOUND"){
								toastr.error('Vacation not found')											
							}else if(response.message == "MISSING_REQUIRED_PARAMETERS"){
								toastr.success("You have missing parameters");
							}
						}	
				    }, 
				    error: function(){
				    	toastr.success("Error in save")
					}
				});
			});
			
			
            $("#close_delete").click(function(){
				
				$("#vacation_delete_modal").hide();
			 });
            
          $("#Close_delete").click(function(){
				
				$("#vacation_delete_modal").hide();
			 });
            

            $('#vacation_table tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = vacation_table.row(tr);
         
                if ( row.child.isShown() ) {
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    row.child( format(row.data()) ).show();
                    tr.addClass('shown');
                }
            } );  
          
       	 


        	var CalendarBasic = function() {
        	    return {
        	        //main function to initiate the module
        	        init: function() {
        	        	var todayDate = moment().startOf('day');
        	            var TODAY = todayDate.format('YYYY-MM-DD');
        	            var calendarEl = document.getElementById('calendar');
        	            var calendar = new FullCalendar.Calendar(calendarEl, {
        	                plugins: [ 'bootstrap', 'interaction', 'dayGrid', 'timeGrid'],
        	                themeSystem: 'bootstrap',


        	                header: {
        	                    left: 'prev,next today',
        	                    center: 'title',
        	                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
        	                },

        	                height: 500,
        	                contentHeight: 480,
        	                aspectRatio: 3,  // see: https://fullcalendar.io/docs/aspectRatio

        	                nowIndicator: true,
        	               // now: TODAY + 'T09:25:00', // just for demo

        	                views: {
        	                    dayGridMonth: { buttonText: 'month' },
        	                    timeGridWeek: { buttonText: 'week' },
        	                    timeGridDay: { buttonText: 'day' },
        	                    listDay: { buttonText: 'list' },
        	                },

        	                defaultView: 'dayGridMonth',
        	                defaultDate: TODAY,

        	                editable: false,
        	                eventLimit: true, // allow "more" link when too many events
        	                navLinks: true,
        	                events:{{vacations|safe}}, 
        	                eventRender: function(info) {
        	                    var element = $(info.el);
        							
        	                    if (info.event.extendedProps && info.event.extendedProps.description) {
        	                        if (element.hasClass('fc-day-grid-event')) {
        	                            element.data('content', info.event.extendedProps.description);
        	                            element.data('placement', 'top');
        	                            
        	                        } else if (element.hasClass('fc-time-grid-event')) {
        	                            element.find('.fc-title').append('<div class="fc-description">' + info.event.extendedProps.description + '</div>');
        	                        } else if (element.find('.fc-list-item-title').lenght !== 0) {
        	                            element.find('.fc-list-item-title').append('<div class="fc-description">' + info.event.extendedProps.description + '</div>');
        	                        }
        	                    }
        	                },

        	            });

        	            calendar.render();
        	        }
        	    };
        	}();
        	
        	CalendarBasic.init();
});


</script>
{% endblock %} 