
{% extends "employee_app/base.html" %}
{% block title %} Vacation managing:{% endblock %}
{% block header %}<h2>Employee Vacation:</h2>{% endblock %}

{% block container_block %}

<style>
 .content {
background:white;
padding-left:50px;
margin-right:0px;
margin-left:-60px;
padding-bottom:15px;} 
.margin{margin-right:250px;
margin-top:50px;}
 .btn {
  background-color: dodgerblue;
  color: white;
  padding: 15px 20px;
  border: none;
  cursor: pointer;
  width: 70%;
  opacity: 0.8;
}
.btn:hover {
  opacity: 1;
}
</style>

<form method="POST" name="Vacation-Fields"  id="vacationfield"  action="{% url 'Vacation_save' %}" >


{% csrf_token %}
<div class="form-group">
<div class="row">
<div class="col-6">
<label for="Description" >Description:</label>
<textarea id="desc" name="desc" rows="2" cols="50"  >{{vacation.Description}}</textarea>
</div>
<div class="col-6">
 <label for="Date_From">DateTime_From:</label>
<input  name="datefrom" id="date_from" value="{{vacation.Datetime_From|date:'Y-m-d'}}" />
</div>
<div class="col-6">
 <label for="Date_To">DateTime_To:</label>
<input  name="dateto" id="date_to"  value="{{vacation.Datetime_To|date:'Y-m-d'}}" />
</div>
<div class="col-6">
 <label for="Duration">Duration:</label>
<input type="text" name="duration_d" id="duration"  value="{{vacation.Duration}}" readonly/><span>days</span></div><br>
<br>

<div class="col-6">
<input type="hidden" name="vacation_id" value="{{vacation.id}}" />
<button type="button" id="Vacation_save" class="btn btn-primary" style="width:60%">Save Vacation</button><br><br>
<a  href="{% url  'Vacation_Table' %}" class="btn btn-primary " id="table" style="width:60%">Vacation Table</a></div><br>
</div>
</div>
</form >

{% endblock %}

<script src="http://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.6.0/dist/umd/popper.min.js" integrity="sha384-KsvD1yqQ1/1+IA7gi3P0tyJcT3vR+NdBTt13hSJ2lnve8agRGXTTyNaBYmCR/Nwi" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/ui/1.11.3/jquery-ui.min.js" integrity="sha256-xI/qyl9vpwWFOXz7+x/9WkG5j/SVnSw21viy8fWwbeE="  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.min.js"></script>

<script src="https://momentjs.com/downloads/moment.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
<script src="https://unpkg.com/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"></script>
<link id="bsdp-css" href="https://unpkg.com/bootstrap-datepicker@1.9.0/dist/css/bootstrap-datepicker3.min.css" rel="stylesheet">




{% block scripts %}
<script>

$(document).ready(function(){
	
	$("#date_from").datepicker({
		'format': "yyyy-mm-dd",
		 startDate: new Date(),
	}).on('changeDate', function(ev) {
	    var dt1 = $('#date_from').data('datepicker').viewDate;
	    var dt2 = $('#date_to').data('datepicker').viewDate;
	    if (dt2 < dt1) {
	        $('#date_to').datepicker('update', $('#date_from').val());
	    }
	    $('#date_to').datepicker('setStartDate', $('#date_from').val());
	    
	    calculationDuration();
		  
			});
	
	$("#date_to").datepicker({
		'format': "yyyy-mm-dd",
		startDate: new Date(),
	}).on('changeDate', function(ev) {
	    var dt1 = $('#date_from').data('datepicker').viewDate;
	    var dt2 = $('#date_to').data('datepicker').viewDate;
	    if (dt2 < dt1) {
	        $('#date_to').datepicker('update', $('#date_from').val());
	    }
	    $('#date_to').datepicker('setStartDate', $('#date_from').val());
	    
	    calculationDuration();
			});

	
	$("#date_from").change(function(){
		calculationDuration();
	});
	
	$("#date_to").change(function(){
		calculationDuration();
	});
	
	 
    
   
	
 $("#vacationfield").validate({
	rules: {
		desc: {
			required: true,
		},
		datefrom: {
			required: true,
		},
		dateto: {
			required: true,
		},
		duration_d: {
			required: true,
		},
	}, 

	messages: {
		desc: {
			required: "Description is required"
		},
		datefrom: {
			required: "Datefrom is required"
		},
		dateto: {
			required: "Dateto is required"
		},
		duration_d: {
			required: "Duration is required"
		},
		
	},
	
	submitHandler: function(){
		$.ajax({
			type:"POST",
		    url:"{% url  'Vacation_save' %}",
		    data:{
		    	desc: $("textarea[name=desc]").val(),
			    datefrom: $("input[name=datefrom]").val(),
			    dateto: $("input[name=dateto]").val(),
			    duration_d: $("input[name=duration_d]").val(),
			    vacation_id: $("input[name=vacation_id]").val(),
			    csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
		    },
		    dataType:'json',
		    success: function(response){
		    	console.log(response)
				
				if(response.status == 'OK'){
					toastr.success('Vacation Saved')
					var vacation_id = response.payload.id;
					$("input[name=vacation_id]").val(vacation_id);
				}else{
					if(response.message == 'FAIL'){
						toastr.success("Fail to save")
					}else if(response.message == "MISSING_REQUIRED_PARAMETERS"){
						toastr.success("You have missing parameters")
					}else if(response.message == 'DESCRIPTION_NAME_ALREADY_EXISTS'){
						toastr.success("Name already found")
					}
				}
			   
		   },
		   error:function(){
			   toastr.success("Error in save")
		   }
	   });
 	} 
	
 });



	$("#Vacation_save").click(function(){
		$("#vacationfield").submit();
	});
})

function calculationDuration(){
		var date_from = $("#date_from").data('datepicker').viewDate;
		var date_to = $("#date_to").data('datepicker').viewDate;
		
		if(date_from && date_to){
			var duration = moment(date_to).diff(moment(date_from), 'days');
			
			$("input[name=duration_d]").val(duration);
		}
		
	}

</script>
{% endblock %}