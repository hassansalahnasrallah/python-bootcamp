{% extends 'base.html' %}
{% load static  %}

{% block block3 %} 
      		<div class="col-6" id="first_div">
      		  <img id="image_1" src="{{MEDIA_URL}}{{user_profile.picture}}" alt="This is an image">
      		   
      		</div>
{% endblock %}
      		
      
 {% block container_block %}
 
<h1>My Profile Form</h1>
<form name="profile_form" id="profile_form" action="" method="POST">
	{% csrf_token %}
	
	
	<label>Profile Image:</label>
	<input type="file" name="profile_img" required/>
	<p></p>
	
	<label>Position:</label>
	<input type="text" name="position" value="{{user_profile.position}}" required/>
	<p></p>
	
	<label>Date of Birth:</label>
	<input type="text" id="date_of_birth" name="date_of_birth" value="{{user_profile.date_of_birth}}" required/>
	<p></p>
	
	<button type="button" id="save_profile" class="btn btn-success">Save</button>

</form>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href= "{% static 'css/profile_form.css' %}">

<script>
	$(function(){
		
		 $( "#profile_form" ).validate({
			  rules: {
				
				position: {
				      required: true,	      
				},
				
				date_of_birth: {
				      required: true,	      
				},
				
				profile_img: {
				      required: true,	      
				},
				   
		
			  },
			  
			  messages: {
		
				  position: {
				      required: "Position name is required"	      
				  },
				
				  date_of_birth: {
				      required: "Date of birth is required"	      
				  },
				
				  profile_img: {
				      required: "Picture is required"	      
				  },
			    
			  },
		
			  submitHandler: function(){
				  
				  var formData = new FormData();
				    
			    	formData.append('profile_img', $('input[name=profile_img]')[0].files[0]); 
			    	formData.append('date_of_birth', $('input[name=date_of_birth]').val());
			    	formData.append('position', $('input[name=position]').val());
			    	formData.append('csrfmiddlewaretoken', $('input[name=csrfmiddlewaretoken]').val());
				  
				  $.ajax({
						method:"POST",
						url:"{% url 'save_profile' %}",
						data: formData,
				        processData: false,
				        contentType: false,
						success: function(response){
							var response = JSON.parse(response)
							
							console.log(response.payload)
							if(response.status == 'OK'){
								toastr.success('Save success')
								$("#image_1").attr('src', '{{MEDIA_URL}}'+response.payload.image_url)
							}else{
								if(response.message == "SYSTEM_ERROR"){
									toastr.error('Fail to save')									
								}
							}	
					    }, 
					    error: function(){
					    	toastr.error('Error in save')
						}
					});

			  }
		
		 });
		
		
		 $("#save_profile").click(function(){
			 $("#profile_form").submit();
	
		 });		
		
		
		$("#date_of_birth").datepicker({
			'format':"dd/mm/yyyy",
	    });
		
	});


</script>
{% endblock %}
 
 