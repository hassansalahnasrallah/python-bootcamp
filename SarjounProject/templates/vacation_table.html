{% extends 'base.html' %}

{% block container%}
		{% csrf_token %}
		<h3 align="center" >Vacation table</h3>
<input type="hidden" name="user_id" value="{{user.id}}"/>
<button class="btn btn-dark btn-sm " type="button" id="table_btn"><i class="fa fa-bars" aria-hidden="true"></i></button>
<button class="btn btn-dark btn-sm " type="button" id="calendar_btn"><i class="fa fa-calendar" aria-hidden="true"></i></button>
<br/>

<div class="col-sm-12" id="calendar_view">
<div id="calendar">
</div>

</div>
		
<div id="table_div" class="col-sm-12">		
	<table id="VacationTable" class="table table-hover table-condensed  responsive row-border cell-border"   style="width:140%;">
		<thead>
			<tr>
				<th> <td class=" details-control"></td> </th>
				<th>Description</th>
				<th>Date from</th>
				<th>Date to</th>
				<th>Duration</th>
				<th>Status</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody>
		
		</tbody>
		<tfoot>
			<tr>
				<th>  </th>
				<th style="width:140px;" data-searchable="true" >Description</th>
				<th style="width:140px;" data-searchable="false" >  </th>
				<th style="width:140px;" data-searchable="false" >  </th>
				<th style="width:140px;" data-searchable="true" >Duration</th>
				<th style="width:140px;" data-searchable="false" >  </th>
				<th style="width:140px;" data-searchable="false">  </th>
			</tr>
		</tfoot>
	</table>
</div>
	<div id="calender"></div>
	<br/>
	<br/>
	<a type="Button" class="btn btn-success "href="{% url 'Add_Vacation' %}">Add Vacation</a>		
	
	
<div class="modal" tabindex="-1" role="dialog" id="vacation_status_modal">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
       <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h5 class="modal-title">Update Vacation Status</h5>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to update?</p>
        <input name="vacation_id" type="hidden" />
      </div>
      <div class="modal-footer">
        <button type="button" id="save_status" class="btn btn-primary">Update</button>
        <button type="button" id="hide_modal" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<div class="modal" role="dialog" id="delete_vacation_modal">
    <div class="modal-dialog">
    
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Delete Vacation </h4>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete vacation?</p>
          <input name="vacation_id" type="hidden" />
        </div>
        <div class="modal-footer">
          <button type="button" id="delete_vacation" class="btn btn-primary">Delete</button>
          <button type="button" class="btn btn-default" id="close_delete" data-dismiss="modal">Close</button>
        </div>
      </div>
      
    </div>
  </div>
{% endblock %}



{% block scripts %}

<script>

function format ( rowData ) {
    var div = $('<div/>')
        .addClass( 'loading' )
        .text( 'Loading...' );
 
    	div.load("{% url 'vacation_details' %}?id="+rowData.id)
 
    return div;
}


/*
function format ( d ) {
    // `d` is the original data object for the row
    return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
        '<tr>'+
            '<td>Description:</td>'+
            '<td>'+d.description+'</td>'+
        '</tr>'+
        '<tr>'+
            '<td>Date From:</td>'+
            '<td>'+d.datefrom+'</td>'+
	    '</tr>'+
	        '<tr>'+
	        '<td>Date To:</td>'+
	        '<td>'+d.dateto+'</td>'+
	    '</tr>'+
		'<tr>'+
		    '<td>Date Duration:</td>'+
		    '<td>'+d.duration+'</td>'+
		'</tr>'+
    
    '</table>';
}
*/
 

$(function(){
	$("#calendar_view").hide();
	$("#table_btn").css("background","red");
	
	$("#table_btn").click(function(){
			
			$("#table_div").show();
			$("#calendar_view").hide();
			$("#table_btn").css("background","red");
			$("#calendar_btn").css("background","#1c1f23");
			

		
	});
	
	$("#calendar_btn").click(function(){
		
		$("#calendar_view").show();
		$("#table_div").hide();
		$("#calendar_btn").css("background","red");
		$("#table_btn").css("background","#1c1f23");
		

	
     });

	var vacation_table = $('#VacationTable').DataTable({
		
		responsive: true,

		ajax: {
			url: '{% url "vacation_grid" %}',
			type: 'POST',
			data: function(d){
				d.csrfmiddlewaretoken = $("input[name=csrfmiddlewaretoken]").val(),
				d.user_id = "{{request.user.id}}"
				
			}
		},

		lengthMenu: [1, 5, 10, 25, 50 ],
		
		pageLength: 10,
		
		processing: true,
		serverSide: true,
		
		columns: [
			{
                "className":      'details-control',
                "orderable":      false,
                "data":           null,
                "defaultContent": ''
            },
	          
			{'data': 'desc', 'name': 'description', 'sortable':true},
			{'data': 'date_from', 'name': 'datefrom', 'sortable':true},
			{'data': 'date_to', 'name': 'dateto', 'sortable':true},
			{'data': 'duration', 'name': 'duration', 'sortable':true},
			{'data': 'status', 'name': 'status'},
			{'data': 'action'}
			
			],
		
			"order": [[1, 'asc']],
		columnDefs: [
			{
				targets: -1, //or 3
				title: 'Actions',
				render: function(data, type, full, meta){
					var edit_vacation = "{% url 'Add_Vacation' %}?id=" + full.id;
					return "<a href='"+edit_vacation+"'>Edit</a> <button class='btn btn-dark btn-sm btn-update' type='button' data-id="+full.id+"><i class='fa fa-refresh' aria-hidden='true'></i></button> <button class='btn btn-dark btn-sm btn-delete' type='button' data-id="+full.id+"><i class='fa fa-trash' aria-hidden='true'></i></button>"
				}
				
			}
		],
		
		createdRow: function(row, data, dataIndex){
			console.log(data)
			if(data['status'] == "Active"){
				$(row).css({'background-color': "white"})
			}else{
				$(row).css({'background-color': "#ff5656"})
			}
		}
	});
	$('#VacationTable tbody').on('click', 'td.details-control', function () {
        var tr = $(this).closest('tr');
        var row = vacation_table.row( tr );
 
        if ( row.child.isShown() ) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            // Open this row
            row.child( format(row.data()) ).show();
            tr.addClass('shown');
        }
    });
	
	$("#VacationTable tfoot th[data-searchable=true]").each(function(){
		var title = $(this).text();
		$(this).html('<input type="text" placeholder="Search '+title+'"/>');
	});
	
	vacation_table.columns().every(function(){
		var column = this;
		$('input',this.footer()).on('change',function(){
			if(column.search()!== this.value){
				column.search(this.value).draw();
			}
		})
	})
	
	$("#VacationTable tbody").on('click', '.btn-update', function(){
		//show dialog
		console.log(2)
		$("#vacation_status_modal").show();
		$("input[name=vacation_id]").val($(this).attr('data-id'));
	});
	
	$("#hide_modal").click(function(){
			
			$("#vacation_status_modal").hide();
	});
	
	$("#save_status").click(function(){
		$.ajax({
			type:"POST",
			url: "{% url 'update_status' %}",
			data:{
				vacation_id: $("input[name=vacation_id]").val(),
				csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
			},
			dataType: 'json',
			success: function(response){
				console.log(response)
				
				if(response.status == 'OK'){
					toastr.success('Vacation status updated');
					vacation_table.ajax.reload(); 
					$("#vacation_status_modal").hide();
				}else{
					if(response.message == "VACATION_NOT_FOUND"){
						toastr.error('Vacation not found')										
					}
				}	
		    }, 
		    error: function(){
		    	toastr.error('An Error Has Occured')
			}
		});
	});
	
	$("#vacation_table tbody").on('click', '.btn-delete', function(){
		
		$("#delete_vacation_modal").show();
		$("input[name=vacation_id]").val($(this).attr('data-id'));
	});
	
	
	$("#close_status").click(function(){
		
		$("#vacation_status_modal").hide();
	 });
	
	$("#VacationTable tbody").on('click', '.btn-delete', function(){
		
		$("#delete_vacation_modal").show();
		$("input[name=vacation_id]").val($(this).attr('data-id'));
	});
	
	 $("#close_modal").click(function(){
		
		$("#delete_vacation_modal").hide();
	 });
	 
	 $("#delete_vacation").click(function(){
			$.ajax({
				type:"POST",
				url: "{% url 'delete_vacation' %}",
				data:{
					vacation_id: $("input[name=vacation_id]").val(),
					csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
				},
				dataType: 'json',
				success: function(response){
					console.log(response)
					
					if(response.status == 'OK'){
						toastr.success('Vacation deleted successfuly');
						vacation_table.ajax.reload(); //to auto update table on success
						$("#delete_vacation_modal").hide();
					}else{
						if(response.message == "VACATION_NOT_FOUND"){
							toastr.error('Vacation not found')											
						}
					}	
			    }, 
			    error: function(){
			    	toastr.error('An Error Has Occured')
				}
			});
		});
	/* var CalendarBasic = function() {

		    return {
		        //main function to initiate the module
		        init: function() {
		        	var todayDate = moment().startOf('day');
		            var TODAY = todayDate.format('YYYY-MM-DD');
		            var calendarEl = document.getElementById('calendar');
		            var calendar = new FullCalendar.Calendar(calendarEl, {
		                plugins: [ 'bootstrap', 'interaction', 'dayGrid', 'timeGrid'],
		                themeSystem: 'bootstrap',


		                header: {
		                    left: 'prev,next today',
		                    center: 'title',
		                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
		                },

		                height: 500,
		                contentHeight: 480,
		                aspectRatio: 3,  // see: https://fullcalendar.io/docs/aspectRatio

		                nowIndicator: true,
		               // now: TODAY + 'T09:25:00', // just for demo

		                views: {
		                    dayGridMonth: { buttonText: 'month' },
		                    timeGridWeek: { buttonText: 'week' },
		                    timeGridDay: { buttonText: 'day' },
		                    listDay: { buttonText: 'list' },
		                },

		                defaultView: 'dayGridMonth',
		                defaultDate: TODAY,

		                editable: false,
		                eventLimit: true, // allow "more" link when too many events
		                navLinks: true,
		                events: {{vacations|safe}},
		                eventRender: function(info) {
		                    var element = $(info.el);
								
		                    if (info.event.extendedProps && info.event.extendedProps.description) {
		                        if (element.hasClass('fc-day-grid-event')) {
		                            element.data('content', info.event.extendedProps.description);
		                            element.data('placement', 'top');
		                        } else if (element.hasClass('fc-time-grid-event')) {
		                            element.find('.fc-title').append('<div class="fc-description">' + info.event.extendedProps.description + '</div>');
		                        } else if (element.find('.fc-list-item-title').lenght !== 0) {
		                            element.find('.fc-list-item-title').append('<div class="fc-description">' + info.event.extendedProps.description + '</div>');
		                        }
		                    }
		                },

		            });

		            calendar.render();
		        }
		    };
		}();
		
		CalendarBasic.init();*/
	
});
</script>


{% endblock%}